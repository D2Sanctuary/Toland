# This workflow will cleanup the old server stuff, clone the repo, do a clean install of node dependencies and restart the server service

name: Deploy

on:
  # Triggers the workflow on push events but only for the main branch
  push:
    branches: [ main ]
    
jobs:
  deploy:

    runs-on: ubuntu-latest

    steps:
    - name: Deploy the nodejs app
      uses: appleboy/ssh-action@v0.1.2
      with: 
        host: ${{secrets.SSH_HOST}}
        key: ${{secrets.SSH_KEY}}
        username: ${{secrets.SSH_USERNAME}}
        
        script: |
          systemctl stop toland
          cd ~/../srv/node
          rm -r Toland
          git clone https://AndiZandi:${{secrets.ACCESS_TOKEN}}@github.com/D2Sanctuary/Toland.git
          cd Toland
          npm install
          sudo dos2unix ./src/index.js
          chmod 777 ./src/index.js
          echo 'BOT_TOKEN=${{secrets.BOT_TOKEN}}' > ./.env          
          systemctl start toland
          echo 'Deployment succesful'
